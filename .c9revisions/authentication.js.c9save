{"revisions":{"1337515492595":{"ts":1337515492595,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"/**\r\n * Created with JetBrains WebStorm.\r\n * User: user\r\n * Date: 12. 5. 8\r\n * Time: 오후 9:26\r\n * To change this template use File | Settings | File Templates.\r\n */\r\n\r\nvar model\r\n  , isAuthenticated\r\n  , salt\r\n  , crypto\r\n  , authenticate\r\n  , signup;\r\n\r\ncrypto = require('crypto');\r\nmodel  = require('./models');\r\nsalt   = 'My Cake is Very Not LOL'\r\n\r\nauthenticate = function(userID, password, callback) {\r\n  model.UserModel().findOne({userID: userID}, function(err, user) {\r\n    if (!userID || !user) {\r\n      callback(null);\r\n      return;\r\n    }\r\n    if (user.password == crypto.createHmac('sha1', salt).update(password).digest('hex')) {\r\n      callback(user);\r\n      return;\r\n    }\r\n    callback(null);\r\n  });\r\n};\r\n\r\nsignup = function(reqData, callback) {\r\n  var userData\r\n    , userModel;\r\n  if (!reqData.userID) {\r\n    callback(null, 'ID를 입력하지도 않고 가입하려는 엄청난 패기로군');\r\n    return;\r\n  }\r\n  if (!reqData.nickname) {\r\n    callback(null, '닉네임을 입력하는 것이 좋을듯합니다.');\r\n    return;\r\n  }\r\n  if (!reqData.password1 || !reqData.password2) {\r\n    callback(null, '보안을 위해 암호를 입력하는 것이 신상에 좋을것이요.');\r\n    return;\r\n  }\r\n  if (!reqData.email) {\r\n    callback(null, '이메일을 입력해주시면 참 고맙겠는데 말입니다.');\r\n    return;\r\n  }\r\n  if (reqData.password1 != reqData.password2) {\r\n    callback(null, '비밀번호를 다르게 입력한듯 하기도 하고 아닌것 같기도 하고. 아무튼 다시 입력해 보세요.');\r\n    return;\r\n  }\r\n  if (reqData.key != 'zMFFNEM1227') {\r\n    callback(null, '키를 잘못 입력하지 않았나스럽다.');\r\n    return;\r\n  }\r\n\r\n  userModel = model.UserModel();\r\n\r\n  reqData.password1 = crypto.createHmac('sha1', salt).update(reqData.password1).digest('hex');\r\n\r\n  userData = new userModel();\r\n  userData.userID   = reqData.userID;\r\n  userData.password = reqData.password1;\r\n  userData.email    = reqData.email;\r\n  userData.nickname = reqData.nickname;\r\n  userData.save(function(err) {\r\n    if (err) {\r\n      if (err.code == 11000) {\r\n        console.log('dup');\r\n        callback(null, '소환사께서 입력하신 아이디 혹은 닉네임은 이미 있는 것으로 사려되옵니다. 다른 아이디 혹은 닉네임을 입력해 주세요.');\r\n      }\r\n    } else {\r\n      console.log('signup success');\r\n      console.log('--' + userData);\r\n      callback(userData);\r\n    }\r\n  });\r\n  return;\r\n};\r\n\r\nexports.getLogin = function(req, res) {\r\n  res.render('sessions/login', {redir: req.headers.referer});\r\n};\r\n\r\nexports.postLogin = function(req, res) {\r\n  authenticate(req.body.userID, req.body.password, function(user) {\r\n    if (user) {\r\n      req.session.user = user;\r\n      res.redirect(req.body.redir || '/');\r\n      return;\r\n    } else {\r\n      res.render('sessions/login', {redir: req.body.redir});\r\n      return;\r\n    }\r\n  });\r\n};\r\n\r\nexports.getSignUp = function(req, res) {\r\n  res.render('sessions/signup', {message: ''});\r\n};\r\n\r\nexports.postSignUp = function(req, res) {\r\n  signup(req.body, function(user, message) {\r\n    if (!message) {\r\n      message = '';\r\n    }\r\n    if (user) {\r\n      req.session.user = user;\r\n      res.redirect('/');\r\n    } else {\r\n      res.render('sessions/signup', {message: message});\r\n    }\r\n  });\r\n};\r\n\r\nexports.logout = function(req, res) {\r\n  delete req.session.user;\r\n  res.redirect('/');\r\n};\r\n"]],"start1":0,"start2":0,"length1":0,"length2":3060}]],"length":3060},"1337550956727":{"contributors":[],"silentsave":false,"ts":1337550956727,"patch":[[{"diffs":[[0,"rect('/');\r\n};\r\n"],[1,"\r\nexports.getUserID = functioc(req, res) {\r\n  \r\n}\r\n"]],"start1":3044,"start2":3044,"length1":16,"length2":67}]],"length":3111,"saved":false},"1337550959554":{"contributors":[],"silentsave":false,"ts":1337550959554,"patch":[[{"diffs":[[0," functio"],[-1,"c"],[1,"n"],[0,"(req, re"]],"start1":3081,"start2":3081,"length1":17,"length2":17}]],"length":3111,"saved":false},"1337550961683":{"contributors":[],"silentsave":false,"ts":1337550961683,"patch":[[{"diffs":[[0,"{\r\n  \r\n}"],[1,";"],[0,"\r\n"]],"start1":3101,"start2":3101,"length1":10,"length2":11}]],"length":3112,"saved":false},"1337550965245":{"contributors":[],"silentsave":false,"ts":1337550965245,"patch":[[{"diffs":[[0,"s) {\r\n  "],[1,"    res.render('sessions/signup', {message: message});"],[0,"\r\n};\r\n"]],"start1":3098,"start2":3098,"length1":14,"length2":68}]],"length":3166,"saved":false},"1337550971980":{"contributors":[],"silentsave":false,"ts":1337550971980,"patch":[[{"diffs":[[0," {\r\n"],[-1,"    "],[0,"  res."],[-1,"r"],[0,"end"],[-1,"er('sessions/signup', {message: message}"],[1,"("],[0,");\r\n"]],"start1":3100,"start2":3100,"length1":62,"length2":18}]],"length":3122,"saved":false},"1337550990281":{"contributors":[],"silentsave":false,"ts":1337550990281,"patch":[[{"diffs":[[0,"res.end("],[1,"req.session.user"],[0,");\r\n};\r\n"]],"start1":3106,"start2":3106,"length1":16,"length2":32}]],"length":3138,"saved":false},"1337551099208":{"contributors":[],"silentsave":false,"ts":1337551099208,"patch":[[{"diffs":[[0,"session.user"],[1,".nickname"],[0,");\r\n};\r\n"]],"start1":3118,"start2":3118,"length1":20,"length2":29}]],"length":3147,"saved":false},"1337551107087":{"contributors":[],"silentsave":false,"ts":1337551107087,"patch":[[{"diffs":[[0,".getUser"],[-1,"ID"],[1,"Nickname"],[0," = funct"]],"start1":3069,"start2":3069,"length1":18,"length2":24}]],"length":3153,"saved":false}}}